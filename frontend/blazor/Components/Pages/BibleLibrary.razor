@page "/bible-library"
@using PalavraConectada.Blazor.Services
@inject BackendApiService BackendApi
@inject NavigationManager Navigation

<PageTitle>Biblioteca B√≠blica üìñ</PageTitle>

<div class="bible-library-container">
    <div class="header">
        <h1>üìñ Biblioteca B√≠blica</h1>
        <p class="subtitle">Explore a Palavra de Deus organizada por testamentos e temas</p>
        
        <!-- BUSCA GLOBAL -->
        <div class="search-bar">
            <input type="text" 
                   @bind="searchKeyword" 
                   @bind:event="oninput"
                   @onkeyup="HandleSearchKey"
                   placeholder="üîç Buscar por palavra-chave..." 
                   class="search-input" />
            <button @onclick="SearchLibrary" disabled="@isLoading" class="btn-search">Buscar</button>
        </div>
    </div>

    <!-- BREADCRUMB / VOLTAR -->
    @if (!string.IsNullOrEmpty(selectedCategory) || selectedBook != null)
    {
        <div class="breadcrumb">
            <button @onclick="GoBack" class="btn-back">‚¨ÖÔ∏è Voltar</button>
            @if (selectedBook != null && selectedChapter.HasValue)
            {
                <span>üìñ @selectedBook / Cap√≠tulo @selectedChapter</span>
            }
            else if (selectedBook != null)
            {
                <span>üìñ @selectedBook</span>
            }
            else
            {
                <span>üìö @GetCategoryName()</span>
            }
        </div>
    }

    <!-- MENU DE CATEGORIAS -->
    @if (string.IsNullOrEmpty(selectedCategory) && searchResults == null)
    {
        <div class="categories-grid">
            <div class="category-card" @onclick='() => SelectCategory("vt")'>
                <div class="category-icon">üìú</div>
                <h3>Velho Testamento</h3>
                <p>39 livros da cria√ß√£o at√© os profetas</p>
                <span class="badge-vt">Lei ‚Ä¢ Profetas ‚Ä¢ Escritos</span>
            </div>

            <div class="category-card" @onclick='() => SelectCategory("nt")'>
                <div class="category-icon">‚úùÔ∏è</div>
                <h3>Novo Testamento</h3>
                <p>27 livros sobre Jesus e a Igreja</p>
                <span class="badge-nt">Evangelhos ‚Ä¢ Cartas ‚Ä¢ Apocalipse</span>
            </div>

            <div class="category-card prosperity" @onclick='() => SelectCategory("prosperity")'>
                <div class="category-icon">üí∞</div>
                <h3>Riqueza & Prosperidade</h3>
                <p>B√™n√ß√£os e abund√¢ncia em Deus</p>
                <span class="badge-theme">Tema Especial</span>
            </div>

            <div class="category-card salvation" @onclick='() => SelectCategory("salvation")'>
                <div class="category-icon">‚ú®</div>
                <h3>Salva√ß√£o em Jesus</h3>
                <p>O plano de Deus para sua vida</p>
                <span class="badge-salvation">Essencial</span>
            </div>
        </div>
    }

    <!-- LOADING -->
    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Carregando...</p>
        </div>
    }

    <!-- RESULTADOS DA BUSCA -->
    @if (searchResults != null)
    {
        <div class="search-results">
            <h2>üîç Resultados para "@searchKeyword"</h2>
            <p class="count">@searchResults.Count resultado(s) encontrado(s)</p>
            
            @if (searchResults.Count > 0)
            {
                <div class="verses-container">
                    @foreach (var verse in searchResults.Verses)
                    {
                        <div class="verse-card">
                            <div class="verse-reference">@GetVerseReference(verse)</div>
                            <div class="verse-text">"@verse.Text"</div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="no-results">Nenhum vers√≠culo encontrado com essa palavra.</p>
            }
        </div>
    }

    <!-- LISTA DE LIVROS (VT/NT) -->
    @if ((selectedCategory == "vt" || selectedCategory == "nt") && selectedBook == null)
    {
        <div class="books-list">
            <h2>@GetCategoryName()</h2>
            <p class="count">@books.Count livro(s)</p>
            
            <div class="books-grid">
                @foreach (var book in books)
                {
                    <button @onclick="() => ViewBook(book.BookName, book.BookAbbrev)" class="book-card">
                        <div class="book-name">@book.BookName</div>
                        <div class="book-details">
                            <span>‚úçÔ∏è @book.Author</span>
                            <span>üìÇ @book.Group</span>
                        </div>
                    </button>
                }
            </div>
        </div>
    }

    <!-- CAP√çTULOS DE UM LIVRO -->
    @if (selectedBook != null && !selectedChapter.HasValue)
    {
        <div class="chapters-view">
            <h2>üìñ @selectedBook</h2>
            <p class="count">@bookChapters?.TotalChapters cap√≠tulo(s)</p>
            
            <div class="chapters-grid">
                @if (bookChapters != null)
                {
                    @foreach (var chapter in bookChapters.Chapters)
                    {
                        <button @onclick="() => ViewChapter(chapter)" class="chapter-card">
                            <div class="chapter-number">@chapter</div>
                        </button>
                    }
                }
            </div>
        </div>
    }

    <!-- VERS√çCULOS DE UM CAP√çTULO -->
    @if (selectedChapter.HasValue && chapterVerses != null)
    {
        <div class="chapter-verses">
            <h2>üìú @selectedBook - Cap√≠tulo @selectedChapter</h2>
            <p class="count">@chapterVerses.Count vers√≠culo(s)</p>
            
            <div class="verses-container">
                @foreach (var verse in chapterVerses.Verses)
                {
                    <div class="verse-card">
                        <span class="verse-number">@verse.Number</span>
                        <span class="verse-text">@verse.Text</span>
                    </div>
                }
            </div>
        </div>
    }

    <!-- TEMA: PROSPERIDADE -->
    @if (selectedCategory == "prosperity" && prosperityVerses != null)
    {
        <div class="theme-view prosperity-theme">
            <h2>üí∞ Riqueza & Prosperidade</h2>
            <p class="description">@prosperityVerses.Description</p>
            <p class="count">Mostrando @prosperityVerses.Count de @prosperityVerses.TotalAvailable vers√≠culos</p>
            
            <div class="verses-container">
                @foreach (var verse in prosperityVerses.Verses)
                {
                    <div class="verse-card">
                        <div class="verse-reference">@GetVerseReference(verse)</div>
                        <div class="verse-text">"@verse.Text"</div>
                    </div>
                }
            </div>

            <button @onclick='() => SelectCategory("prosperity")' class="btn-reload">
                üîÑ Carregar Mais Vers√≠culos
            </button>
        </div>
    }

    <!-- TEMA: SALVA√á√ÉO -->
    @if (selectedCategory == "salvation" && salvationData != null)
    {
        <div class="theme-view salvation-theme">
            <h2>‚ú® Salva√ß√£o em Jesus Cristo</h2>
            <p class="description">@salvationData.Description</p>
            
            <!-- PASSOS DA SALVA√á√ÉO -->
            <div class="salvation-steps">
                <h3>üìñ O Plano de Salva√ß√£o:</h3>
                @foreach (var step in salvationData.Steps)
                {
                    <div class="step">@step</div>
                }
            </div>

            <p class="count">Mostrando @salvationData.Count de @salvationData.TotalAvailable vers√≠culos</p>

            <!-- VERS√çCULOS -->
            <div class="verses-container">
                @foreach (var verse in salvationData.Verses)
                {
                    <div class="verse-card">
                        <div class="verse-reference">@GetVerseReference(verse)</div>
                        <div class="verse-text">"@verse.Text"</div>
                    </div>
                }
            </div>

            <button @onclick='() => SelectCategory("salvation")' class="btn-reload">
                üîÑ Carregar Mais Vers√≠culos
            </button>

            <!-- ORA√á√ÉO DE SALVA√á√ÉO -->
            <div class="salvation-prayer">
                <button @onclick="() => showPrayer = !showPrayer" class="btn-prayer">
                    üôè @(showPrayer ? "Esconder Ora√ß√£o" : "Fazer a Ora√ß√£o de Salva√ß√£o") üôè
                </button>

                @if (showPrayer)
                {
                    <div class="prayer-box">
                        <h3>Minha Ora√ß√£o de Salva√ß√£o</h3>
                        <p>
                            "Senhor Jesus, eu reconhe√ßo que sou pecador(a) e que preciso do Teu perd√£o.
                            Eu creio que morreste na cruz por mim e ressuscitaste ao terceiro dia.
                            Hoje, eu abro meu cora√ß√£o e Te recebo como meu √∫nico Senhor e Salvador.
                            Lava-me de todo pecado e escreve meu nome no Livro da Vida.
                            Eu Te agrade√ßo pela salva√ß√£o e pela vida eterna. Am√©m."
                        </p>
                        <p class="welcome-message">üéâ Bem-vindo(a) √† fam√≠lia de Deus! üéâ</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private string searchKeyword = string.Empty;
    private string selectedCategory = string.Empty;
    private string? selectedBook = null;
    private string? selectedBookAbbrev = null;
    private int? selectedChapter = null;
    private bool isLoading = false;
    private bool showPrayer = false;

    // Dados
    private List<BookDto> books = new();
    private BookChaptersResponse? bookChapters;
    private ChapterVersesResponse? chapterVerses;
    private ThemeResponse? prosperityVerses;
    private SalvationResponse? salvationData;
    private SearchLibraryResponse? searchResults;

    private async Task SelectCategory(string category)
    {
        selectedCategory = category;
        selectedBook = null;
        selectedChapter = null;
        searchResults = null;
        isLoading = true;

        try
        {
            switch (category)
            {
                case "vt":
                    var vtResponse = await BackendApi.GetOldTestamentAsync();
                    books = vtResponse?.Books ?? new List<BookDto>();
                    break;

                case "nt":
                    var ntResponse = await BackendApi.GetNewTestamentAsync();
                    books = ntResponse?.Books ?? new List<BookDto>();
                    break;

                case "prosperity":
                    prosperityVerses = await BackendApi.GetProsperityVersesAsync();
                    break;

                case "salvation":
                    salvationData = await BackendApi.GetSalvationVersesAsync();
                    break;
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewBook(string bookName, string bookAbbrev)
    {
        selectedBook = bookName;
        selectedBookAbbrev = bookAbbrev;
        isLoading = true;

        try
        {
            bookChapters = await BackendApi.GetBookChaptersAsync(bookAbbrev);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewChapter(int chapterNumber)
    {
        selectedChapter = chapterNumber;
        isLoading = true;

        try
        {
            chapterVerses = await BackendApi.GetChapterVersesAsync(selectedBookAbbrev!, chapterNumber);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SearchLibrary()
    {
        if (string.IsNullOrWhiteSpace(searchKeyword))
            return;

        selectedCategory = string.Empty;
        selectedBook = null;
        isLoading = true;

        try
        {
            searchResults = await BackendApi.SearchLibraryAsync(searchKeyword);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSearchKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchLibrary();
        }
    }

    private void GoBack()
    {
        if (selectedChapter.HasValue)
        {
            selectedChapter = null;
            chapterVerses = null;
        }
        else if (selectedBook != null)
        {
            selectedBook = null;
            selectedBookAbbrev = null;
            bookChapters = null;
        }
        else
        {
            selectedCategory = string.Empty;
            searchResults = null;
        }
    }

    private string GetCategoryName()
    {
        return selectedCategory switch
        {
            "vt" => "üìú Velho Testamento",
            "nt" => "‚úùÔ∏è Novo Testamento",
            "prosperity" => "üí∞ Riqueza & Prosperidade",
            "salvation" => "‚ú® Salva√ß√£o em Jesus",
            _ => "üìö Biblioteca B√≠blica"
        };
    }

    private string GetVerseReference(VerseDto verse)
    {
        return $"{verse.BookName} {verse.Chapter}:{verse.Number}";
    }
}
