@page "/bible-library"
@using PalavraConectada.Blazor.Services
@inject BackendApiService BackendApi
@inject NavigationManager Navigation

<PageTitle>Biblioteca BÃ­blica ğŸ“–</PageTitle>

<div class="bible-library-container">
    <div class="header">
        <h1>ğŸ“– Biblioteca BÃ­blica</h1>
        <p class="subtitle">Explore a Palavra de Deus organizada por testamentos e temas</p>
        
        <!-- BUSCA GLOBAL -->
        <div class="search-bar">
            <input type="text" 
                   @bind="searchKeyword" 
                   @bind:event="oninput"
                   @onkeyup="HandleSearchKey"
                   placeholder="ğŸ” Buscar por palavra-chave..." 
                   class="search-input" />
            <button @onclick="SearchLibrary" disabled="@isLoading" class="btn-search">Buscar</button>
        </div>
    </div>

    <!-- BREADCRUMB / NAVEGAÃ‡ÃƒO -->
    @if (!string.IsNullOrEmpty(selectedCategory) || selectedBook != null || searchResults != null)
    {
        <div class="breadcrumb">
            <button @onclick="GoToHome" class="btn-home">ğŸ  InÃ­cio</button>
            <button @onclick="GoBack" class="btn-back">â¬…ï¸ Voltar</button>
            
            <span class="breadcrumb-path">
                @if (selectedBook != null && selectedChapter.HasValue)
                {
                    <span>ğŸ“š Biblioteca â†’ @GetCategoryName() â†’ ğŸ“– @selectedBook â†’ CapÃ­tulo @selectedChapter</span>
                }
                else if (selectedBook != null)
                {
                    <span>ğŸ“š Biblioteca â†’ @GetCategoryName() â†’ ğŸ“– @selectedBook</span>
                }
                else if (searchResults != null)
                {
                    <span>ğŸ“š Biblioteca â†’ ğŸ” Busca: "@searchKeyword"</span>
                }
                else
                {
                    <span>ğŸ“š Biblioteca â†’ @GetCategoryName()</span>
                }
            </span>
        </div>
    }

    <!-- MENU DE CATEGORIAS -->
    @if (string.IsNullOrEmpty(selectedCategory) && searchResults == null)
    {
        <div class="categories-grid">
            <div class="category-card" @onclick='() => SelectCategory("vt")'>
                <div class="category-icon">ğŸ“œ</div>
                <h3>Velho Testamento</h3>
                <p>39 livros da criaÃ§Ã£o atÃ© os profetas</p>
                <span class="badge-vt">Lei â€¢ Profetas â€¢ Escritos</span>
            </div>

            <div class="category-card" @onclick='() => SelectCategory("nt")'>
                <div class="category-icon">âœï¸</div>
                <h3>Novo Testamento</h3>
                <p>27 livros sobre Jesus e a Igreja</p>
                <span class="badge-nt">Evangelhos â€¢ Cartas â€¢ Apocalipse</span>
            </div>

            <div class="category-card prosperity" @onclick='() => SelectCategory("prosperity")'>
                <div class="category-icon">ğŸ’°</div>
                <h3>Riqueza & Prosperidade</h3>
                <p>BÃªnÃ§Ã£os e abundÃ¢ncia em Deus</p>
                <span class="badge-theme">Tema Especial</span>
            </div>

            <div class="category-card salvation" @onclick='() => SelectCategory("salvation")'>
                <div class="category-icon">âœ¨</div>
                <h3>SalvaÃ§Ã£o em Jesus</h3>
                <p>O plano de Deus para sua vida</p>
                <span class="badge-salvation">Essencial</span>
            </div>
        </div>
    }

    <!-- LOADING -->
    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Carregando...</p>
        </div>
    }

    <!-- RESULTADOS DA BUSCA -->
    @if (searchResults != null)
    {
        <div class="search-results">
            <h2>ğŸ” Resultados para "@searchKeyword"</h2>
            <p class="count">@searchResults.Count resultado(s) encontrado(s)</p>
            
            @if (searchResults.Count > 0)
            {
                <div class="verses-container">
                    @foreach (var verse in searchResults.Verses)
                    {
                        <div class="verse-card">
                            <div class="verse-reference">@GetVerseReference(verse)</div>
                            <div class="verse-text">"@verse.Text"</div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="no-results">Nenhum versÃ­culo encontrado com essa palavra.</p>
            }
        </div>
    }

    <!-- LISTA DE LIVROS (VT/NT) -->
    @if ((selectedCategory == "vt" || selectedCategory == "nt") && selectedBook == null)
    {
        <div class="books-list">
            <h2>@GetCategoryName()</h2>
            <p class="count">@books.Count livro(s)</p>
            
            <div class="books-grid">
                @foreach (var book in books)
                {
                    <button @onclick="() => ViewBook(book.BookName, book.BookAbbrev)" class="book-card">
                        <div class="book-name">@book.BookName</div>
                        <div class="book-details">
                            <span>âœï¸ @book.Author</span>
                            <span>ğŸ“‚ @book.Group</span>
                        </div>
                    </button>
                }
            </div>
        </div>
    }

    <!-- CAPÃTULOS DE UM LIVRO -->
    @if (selectedBook != null && !selectedChapter.HasValue)
    {
        <div class="chapters-view">
            <h2>ğŸ“– @selectedBook</h2>
            <p class="count">@bookChapters?.TotalChapters capÃ­tulo(s)</p>
            
            <div class="chapters-grid">
                @if (bookChapters != null)
                {
                    @foreach (var chapter in bookChapters.Chapters)
                    {
                        <button @onclick="() => ViewChapter(chapter)" class="chapter-card">
                            <div class="chapter-number">@chapter</div>
                        </button>
                    }
                }
            </div>
        </div>
    }

    <!-- VERSÃCULOS DE UM CAPÃTULO -->
    @if (selectedChapter.HasValue && chapterVerses != null)
    {
        <div class="chapter-verses">
            <h2>ğŸ“œ @selectedBook - CapÃ­tulo @selectedChapter</h2>
            <p class="count">@chapterVerses.Count versÃ­culo(s)</p>
            
            <div class="verses-container">
                @foreach (var verse in chapterVerses.Verses)
                {
                    <div class="verse-card">
                        <span class="verse-number">@verse.Number</span>
                        <span class="verse-text">@verse.Text</span>
                    </div>
                }
            </div>
        </div>
    }

    <!-- TEMA: PROSPERIDADE -->
    @if (selectedCategory == "prosperity" && prosperityVerses != null)
    {
        <div class="theme-view prosperity-theme">
            <h2>ğŸ’° Riqueza & Prosperidade</h2>
            <p class="description">@prosperityVerses.Description</p>
            <p class="count">Mostrando @prosperityVerses.Count de @prosperityVerses.TotalAvailable versÃ­culos</p>
            
            <div class="verses-container">
                @foreach (var verse in prosperityVerses.Verses)
                {
                    <div class="verse-card">
                        <div class="verse-reference">@GetVerseReference(verse)</div>
                        <div class="verse-text">"@verse.Text"</div>
                    </div>
                }
            </div>

            <button @onclick='() => SelectCategory("prosperity")' class="btn-reload">
                ğŸ”„ Carregar Mais VersÃ­culos
            </button>
        </div>
    }

    <!-- TEMA: SALVAÃ‡ÃƒO -->
    @if (selectedCategory == "salvation" && salvationData != null)
    {
        <div class="theme-view salvation-theme">
            <h2>âœ¨ SalvaÃ§Ã£o em Jesus Cristo</h2>
            <p class="description">@salvationData.Description</p>
            
            <!-- PASSOS DA SALVAÃ‡ÃƒO -->
            <div class="salvation-steps">
                <h3>ğŸ“– O Plano de SalvaÃ§Ã£o:</h3>
                @foreach (var step in salvationData.Steps)
                {
                    <div class="step">@step</div>
                }
            </div>

            <p class="count">Mostrando @salvationData.Count de @salvationData.TotalAvailable versÃ­culos</p>

            <!-- VERSÃCULOS -->
            <div class="verses-container">
                @foreach (var verse in salvationData.Verses)
                {
                    <div class="verse-card">
                        <div class="verse-reference">@GetVerseReference(verse)</div>
                        <div class="verse-text">"@verse.Text"</div>
                    </div>
                }
            </div>

            <button @onclick='() => SelectCategory("salvation")' class="btn-reload">
                ğŸ”„ Carregar Mais VersÃ­culos
            </button>

            <!-- ORAÃ‡ÃƒO DE SALVAÃ‡ÃƒO -->
            <div class="salvation-prayer">
                <button @onclick="() => showPrayer = !showPrayer" class="btn-prayer">
                    ğŸ™ @(showPrayer ? "Esconder OraÃ§Ã£o" : "Fazer a OraÃ§Ã£o de SalvaÃ§Ã£o") ğŸ™
                </button>

                @if (showPrayer)
                {
                    <div class="prayer-box">
                        <h3>Minha OraÃ§Ã£o de SalvaÃ§Ã£o</h3>
                        <p>
                            "Senhor Jesus, eu reconheÃ§o que sou pecador(a) e que preciso do Teu perdÃ£o.
                            Eu creio que morreste na cruz por mim e ressuscitaste ao terceiro dia.
                            Hoje, eu abro meu coraÃ§Ã£o e Te recebo como meu Ãºnico Senhor e Salvador.
                            Lava-me de todo pecado e escreve meu nome no Livro da Vida.
                            Eu Te agradeÃ§o pela salvaÃ§Ã£o e pela vida eterna. AmÃ©m."
                        </p>
                        <p class="welcome-message">ğŸ‰ Bem-vindo(a) Ã  famÃ­lia de Deus! ğŸ‰</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private string searchKeyword = string.Empty;
    private string selectedCategory = string.Empty;
    private string? selectedBook = null;
    private string? selectedBookAbbrev = null;
    private int? selectedChapter = null;
    private bool isLoading = false;
    private bool showPrayer = false;

    // Dados
    private List<BookDto> books = new();
    private BookChaptersResponse? bookChapters;
    private ChapterVersesResponse? chapterVerses;
    private ThemeResponse? prosperityVerses;
    private SalvationResponse? salvationData;
    private SearchLibraryResponse? searchResults;

    private async Task SelectCategory(string category)
    {
        selectedCategory = category;
        selectedBook = null;
        selectedChapter = null;
        searchResults = null;
        isLoading = true;

        try
        {
            switch (category)
            {
                case "vt":
                    var vtResponse = await BackendApi.GetOldTestamentAsync();
                    books = vtResponse?.Books ?? new List<BookDto>();
                    break;

                case "nt":
                    var ntResponse = await BackendApi.GetNewTestamentAsync();
                    books = ntResponse?.Books ?? new List<BookDto>();
                    break;

                case "prosperity":
                    prosperityVerses = await BackendApi.GetProsperityVersesAsync();
                    break;

                case "salvation":
                    salvationData = await BackendApi.GetSalvationVersesAsync();
                    break;
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewBook(string bookName, string bookAbbrev)
    {
        selectedBook = bookName;
        selectedBookAbbrev = bookAbbrev;
        isLoading = true;

        try
        {
            bookChapters = await BackendApi.GetBookChaptersAsync(bookAbbrev);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewChapter(int chapterNumber)
    {
        selectedChapter = chapterNumber;
        isLoading = true;

        try
        {
            chapterVerses = await BackendApi.GetChapterVersesAsync(selectedBookAbbrev!, chapterNumber);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SearchLibrary()
    {
        if (string.IsNullOrWhiteSpace(searchKeyword))
            return;

        selectedCategory = string.Empty;
        selectedBook = null;
        isLoading = true;

        try
        {
            searchResults = await BackendApi.SearchLibraryAsync(searchKeyword);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSearchKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchLibrary();
        }
    }

    private void GoBack()
    {
        if (selectedChapter.HasValue)
        {
            selectedChapter = null;
            chapterVerses = null;
        }
        else if (selectedBook != null)
        {
            selectedBook = null;
            selectedBookAbbrev = null;
            bookChapters = null;
        }
        else
        {
            selectedCategory = string.Empty;
            searchResults = null;
        }
    }

    private void GoToHome()
    {
        selectedCategory = string.Empty;
        selectedBook = null;
        selectedBookAbbrev = null;
        selectedChapter = null;
        bookChapters = null;
        chapterVerses = null;
        searchResults = null;
        searchKeyword = string.Empty;
        showPrayer = false;
    }

    private string GetCategoryName()
    {
        return selectedCategory switch
        {
            "vt" => "ğŸ“œ Velho Testamento",
            "nt" => "âœï¸ Novo Testamento",
            "prosperity" => "ğŸ’° Riqueza & Prosperidade",
            "salvation" => "âœ¨ SalvaÃ§Ã£o em Jesus",
            _ => "ğŸ“š Biblioteca BÃ­blica"
        };
    }

    private string GetVerseReference(VerseDto verse)
    {
        return $"{verse.BookName} {verse.Chapter}:{verse.Number}";
    }
}
